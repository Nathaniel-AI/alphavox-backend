{% extends 'layout.html' %}

{% block title %}AlphaVox - Neural Core Control{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Additional styles specific to AI Control Center */
    .neural-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            radial-gradient(rgba(0, 148, 255, 0.1) 2px, transparent 2px),
            radial-gradient(rgba(0, 148, 255, 0.15) 2px, transparent 2px);
        background-size: 30px 30px;
        background-position: 0 0, 15px 15px;
        z-index: -1;
        pointer-events: none;
    }
    
    .neural-pulse {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background: linear-gradient(to top, 
            rgba(0, 30, 60, 0.3), 
            rgba(0, 0, 0, 0));
        z-index: -1;
        animation: pulse 8s infinite ease-in-out;
        pointer-events: none;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.1; }
        50% { opacity: 0.3; }
    }
    
    .system-card {
        border: 1px solid rgba(0, 148, 255, 0.6);
        background: linear-gradient(to bottom, 
            rgba(0, 20, 40, 0.8), 
            rgba(0, 10, 30, 0.8));
        box-shadow: 0 0 20px rgba(0, 148, 255, 0.2);
    }
    
    .system-card .card-header {
        background: linear-gradient(to right, 
            rgba(0, 40, 80, 0.6), 
            rgba(0, 20, 50, 0.6));
        border-bottom: 1px solid rgba(0, 148, 255, 0.6);
    }
    
    .improvement-item {
        transition: all 0.3s ease;
        border-left: 3px solid rgba(0, 148, 255, 0.6);
    }
    
    .improvement-item:hover {
        background-color: rgba(0, 40, 80, 0.4);
    }
    
    .code-status {
        position: relative;
        padding-left: 15px;
    }
    
    .code-status::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: currentColor;
        box-shadow: 0 0 8px currentColor;
    }
    
    .code-status.status-applied {
        color: #00cc88;
    }
    
    .code-status.status-pending {
        color: #ffaa00;
    }
    
    .code-status.status-rejected {
        color: #ff5555;
    }
    
    .neural-btn {
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0, 148, 255, 0.6);
        background: linear-gradient(to bottom, 
            rgba(0, 60, 120, 0.8), 
            rgba(0, 30, 80, 0.8));
        color: white;
        transition: all 0.3s ease;
    }
    
    .neural-btn::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -60%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            to right,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.1) 100%
        );
        transform: rotate(30deg);
        transition: transform 0.5s;
    }
    
    .neural-btn:hover {
        box-shadow: 0 0 15px rgba(0, 148, 255, 0.5);
        transform: translateY(-2px);
    }
    
    .neural-btn:hover::after {
        transform: rotate(30deg) translate(10%, 10%);
    }
    
    .terminal-output {
        font-family: 'Share Tech Mono', monospace;
        background-color: rgba(0, 20, 40, 0.7);
        color: #0094ff;
        border: 1px solid rgba(0, 148, 255, 0.4);
        border-radius: 4px;
        padding: 10px;
        font-size: 0.85rem;
        max-height: 150px;
        overflow-y: auto;
    }
    
    .processor-stats {
        position: relative;
        padding: 15px;
        background: linear-gradient(to bottom, 
            rgba(0, 20, 40, 0.7), 
            rgba(0, 10, 30, 0.7));
        border: 1px solid rgba(0, 148, 255, 0.4);
        border-radius: 4px;
    }
    
    .processor-bar {
        height: 4px;
        margin-bottom: 15px;
        background-color: rgba(0, 50, 80, 0.5);
        position: relative;
        overflow: hidden;
    }
    
    .processor-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(to right, 
            rgba(0, 148, 255, 0), 
            rgba(0, 148, 255, 0.6), 
            rgba(0, 148, 255, 0));
        animation: processor-scan 3s infinite linear;
    }
    
    @keyframes processor-scan {
        0% { left: -50%; }
        100% { left: 100%; }
    }
    
    /* Status node animations */
    .status-nodes {
        display: flex;
        gap: 3px;
    }
    
    .status-node {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: rgba(0, 148, 255, 0.6);
        animation: node-pulse 1.5s infinite;
    }
    
    .status-node:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .status-node:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    .status-node:nth-child(4) {
        animation-delay: 0.6s;
    }
    
    .status-node:nth-child(5) {
        animation-delay: 0.8s;
    }
    
    @keyframes node-pulse {
        0%, 100% { 
            transform: scale(1);
            opacity: 0.6;
        }
        50% { 
            transform: scale(1.5);
            opacity: 1;
        }
    }
    
    /* Neural Learning Core Styles */
    .learning-card {
        transition: all 0.3s ease-in-out;
        background: rgba(0, 30, 60, 0.5);
        border: 1px solid rgba(0, 148, 255, 0.3);
    }
    
    .learning-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 25px rgba(0, 148, 255, 0.4);
    }
    
    .neural-result {
        font-family: 'Share Tech Mono', monospace;
        background-color: rgba(0, 20, 40, 0.7);
        color: #0094ff;
        border: 1px solid rgba(0, 148, 255, 0.4);
        border-radius: 4px;
        padding: 15px;
        height: 150px;
        overflow-y: auto;
    }
    
    .root-cause-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .root-emotional_state { background-color: #ff5c8d; }
    .root-sensory_trigger { background-color: #4fc3f7; }
    .root-communication_intent { background-color: #66bb6a; }
    .root-social_context { background-color: #ffca28; }
    .root-cognitive_load { background-color: #ab47bc; }
    .root-unknown { background-color: #78909c; }

    .insight-item {
        padding: 10px 15px;
        border-left: 3px solid #0094ff;
        margin-bottom: 10px;
        background: rgba(0, 40, 80, 0.3);
        border-radius: 4px;
    }
    
    .confidence-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: rgba(0, 30, 60, 0.8);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="neural-grid"></div>
    <div class="neural-pulse"></div>
    
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 cyber-title text-center">Neural Core Control</h1>
            <p class="lead text-center">Advanced interface for AlphaVox autonomous neural systems</p>
            <div class="d-flex justify-content-center mb-4">
                <div class="status-nodes">
                    <div class="status-node"></div>
                    <div class="status-node"></div>
                    <div class="status-node"></div>
                    <div class="status-node"></div>
                    <div class="status-node"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card system-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-brain me-2"></i>Neural Learning Core</h5>
                    <div>
                        <button id="start-learning" class="btn neural-btn btn-sm" {% if learning_active %}style="display: none;"{% endif %}>
                            <i class="fas fa-play me-2"></i>Initialize Learning
                        </button>
                        <button id="stop-learning" class="btn neural-btn btn-sm" {% if not learning_active %}style="display: none;"{% endif %}>
                            <i class="fas fa-pause me-2"></i>Suspend Learning
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>Learning Status</h6>
                                <span id="learning-status" class="badge {% if learning_active %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                    {{ "Active" if learning_active else "Inactive" }}
                                </span>
                            </div>
                            <div class="mb-3">
                                <h6>Last Optimization</h6>
                                <span id="last-optimization">{{ last_optimization or "Never" }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>Interactions Analyzed</h6>
                                <span id="interactions-count">{{ interactions_count or 0 }}</span>
                            </div>
                            <div class="mb-3">
                                <h6>Learning Model</h6>
                                <span class="badge bg-info">Multimodal LSTM</span>
                                <span class="badge bg-info">Adaptive Feedback</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="learning-progress" class="progress-bar bg-info" role="progressbar" 
                             aria-valuenow="{{ learning_progress|default(0) }}" aria-valuemin="0" aria-valuemax="100">
                            <span class="fw-bold">{{ learning_progress or 0 }}% Learning Capacity</span>
                        </div>
                    </div>
                    
                    <h6 class="mt-4">Active Learning Actions</h6>
                    <ul id="learning-actions" class="list-group list-group-flush bg-dark">
                        {% for action in learning_actions %}
                            <li class="list-group-item bg-dark text-white border-secondary improvement-item">
                                <div class="d-flex align-items-center">
                                    <div class="me-2 position-relative">
                                        <i class="fas fa-cog fa-spin text-info"></i>
                                        <span class="position-absolute top-0 start-100 translate-middle" style="width: 6px; height: 6px; background-color: #00ccff; border-radius: 50%;"></span>
                                    </div>
                                    <span class="cyber-text">{{ action }}</span>
                                </div>
                            </li>
                        {% endfor %}
                        {% if not learning_actions %}
                            <li class="list-group-item bg-dark text-white border-secondary text-center">
                                No active learning actions
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card system-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-code-branch me-2"></i>Code Adaptation System</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Self-Modification Status</h6>
                        <span id="modification-status" class="badge {% if auto_mode_active %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                            {{ "Active" if auto_mode_active else "Inactive" }}
                        </span>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Pending Modifications</h6>
                        <span id="pending-mods-count" class="badge bg-warning">{{ pending_modifications_count or 0 }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Applied Modifications</h6>
                        <span id="applied-mods-count" class="badge bg-success">{{ applied_modifications_count or 0 }}</span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button id="start-auto-mode" class="btn neural-btn" {% if auto_mode_active %}style="display: none;"{% endif %}>
                            <i class="fas fa-code me-2"></i>Initialize Code Evolution
                        </button>
                        <button id="stop-auto-mode" class="btn neural-btn" {% if not auto_mode_active %}style="display: none;"{% endif %}>
                            <i class="fas fa-code-branch me-2"></i>Suspend Code Evolution
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card system-card">
                <div class="card-header">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-microchip me-2"></i>Neural Processor Stats</h5>
                </div>
                <div class="card-body">
                    <div class="processor-stats mb-3">
                        <div class="processor-bar"></div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="d-block cyber-text">Model Confidence</span>
                                <span class="cyber-text">{{ confidence_score or 75 }}%</span>
                            </div>
                            <div class="progress cyber-progress" style="height: 6px;">
                                <div class="progress-bar" style="width: {{ confidence_score or 75 }}%; background-color: #00cc88;" 
                                     aria-valuenow="{{ confidence_score or 75 }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="d-block cyber-text">Intent Recognition</span>
                                <span class="cyber-text">{{ intent_recognition or 82 }}%</span>
                            </div>
                            <div class="progress cyber-progress" style="height: 6px;">
                                <div class="progress-bar" style="width: {{ intent_recognition or 82 }}%; background-color: #0094ff;" 
                                     aria-valuenow="{{ intent_recognition or 82 }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="d-block cyber-text">Emotion Processing</span>
                                <span class="cyber-text">{{ emotion_processing or 68 }}%</span>
                            </div>
                            <div class="progress cyber-progress" style="height: 6px;">
                                <div class="progress-bar" style="width: {{ emotion_processing or 68 }}%; background-color: #00ccff;" 
                                     aria-valuenow="{{ emotion_processing or 68 }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-0">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="d-block cyber-text">Self-Repair Capability</span>
                                <span class="cyber-text">{{ self_repair or 54 }}%</span>
                            </div>
                            <div class="progress cyber-progress" style="height: 6px;">
                                <div class="progress-bar" style="width: {{ self_repair or 54 }}%; background-color: #ffaa00;" 
                                     aria-valuenow="{{ self_repair or 54 }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="terminal-output mt-3">
                        <div>> Neural core online</div>
                        <div>> Running diagnostics...</div>
                        <div>> Optimizing memory allocation</div>
                        <div>> System status: operational</div>
                        <div>> Ready for new neural pathways</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card system-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-level-up-alt me-2"></i>Neural Enhancements</h5>
                    <button id="refresh-improvements" class="btn neural-btn btn-sm" type="button" title="Refresh the list of recent improvements">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="improvements-list" class="list-group list-group-flush bg-dark">
                        {% for improvement in recent_improvements %}
                        <div class="list-group-item bg-dark text-white border-secondary improvement-item">
                            <div class="processor-bar" style="height: 2px; margin-bottom: 10px;"></div>
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 cyber-text"><i class="fas fa-lightbulb me-2"></i>{{ improvement.description }}</h6>
                                <small class="text-info">{{ improvement.timestamp }}</small>
                            </div>
                            <p class="mb-1 small">{{ improvement.details }}</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="progress cyber-progress" style="height: 4px; width: 70%;">
                                    <div class="progress-bar" style="width: {{ improvement.confidence }}%; background-color: #00cc88;"></div>
                                </div>
                                <small class="text-info">Confidence: {{ improvement.confidence }}%</small>
                            </div>
                        </div>
                        {% endfor %}
                        {% if not recent_improvements %}
                        <div class="list-group-item bg-dark text-white border-secondary text-center">
                            No recent improvements
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card system-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-code me-2"></i>Code Evolution Status</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn neural-btn active" data-filter="all">All</button>
                        <button type="button" class="btn neural-btn" data-filter="pending">Pending</button>
                        <button type="button" class="btn neural-btn" data-filter="applied">Applied</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="modifications-list" class="list-group list-group-flush bg-dark">
                        {% for mod in recent_modifications %}
                        <div class="list-group-item bg-dark text-white border-secondary improvement-item" data-status="{{ mod.status }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 cyber-text"><i class="fas fa-file-code me-2"></i>{{ mod.file_path }}</h6>
                                <span class="code-status status-{{ mod.status }}">
                                    {{ mod.status }}
                                </span>
                            </div>
                            <p class="mb-1 small">{{ mod.description }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small>{{ mod.timestamp }}</small>
                                <button class="btn neural-btn btn-sm view-diff-btn" data-id="{{ loop.index }}">
                                    <i class="fas fa-code-branch me-1"></i>View Changes
                                </button>
                            </div>
                            <div class="code-diff mt-2" id="diff-{{ loop.index }}" style="display: none;">
                                <pre class="bg-dark"><code>{{ mod.diff }}</code></pre>
                            </div>
                        </div>
                        {% endfor %}
                        {% if not recent_modifications %}
                        <div class="list-group-item bg-dark text-white border-secondary text-center">
                            No recent code modifications
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card system-card">
                <div class="card-header">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-robot me-2"></i>Neural System Enhancement Request</h5>
                </div>
                <div class="card-body">
                    <div class="processor-bar mb-4"></div>
                    
                    <form id="custom-improvement-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="file-path" class="form-label cyber-text">Target Module Path</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-code"></i></span>
                                        <input type="text" class="form-control" id="file-path" placeholder="e.g., nonverbal_engine.py">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="modification-type" class="form-label cyber-text">Enhancement Protocol</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-code-branch"></i></span>
                                        <select class="form-select" id="modification-type">
                                            <option value="bugfix">Anomaly Correction</option>
                                            <option value="optimization">Performance Optimization</option>
                                            <option value="feature">Capability Extension</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="issue-description" class="form-label cyber-text">Enhancement Parameters</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-terminal"></i></span>
                                <textarea class="form-control" id="issue-description" rows="3" placeholder="Specify enhancement requirements..."></textarea>
                            </div>
                            <small class="text-muted mt-1">Detail the specific improvements needed for the neural system to evolve.</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="status-nodes">
                                <div class="status-node"></div>
                                <div class="status-node"></div>
                                <div class="status-node"></div>
                            </div>
                            <button type="submit" class="btn neural-btn">
                                <i class="fas fa-microchip me-2"></i>Initiate Neural Enhancement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Neural Learning Core Analysis Tab -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card system-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0 cyber-title"><i class="fas fa-brain me-2"></i>Neural Learning Core Analysis</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="nlcTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="interaction-tab" data-bs-toggle="tab" 
                                    data-bs-target="#interaction-pane" type="button" role="tab" 
                                    aria-controls="interaction-pane" aria-selected="true">
                                <i class="fas fa-exchange-alt me-1"></i> Interaction Analysis
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="insights-tab" data-bs-toggle="tab"
                                    data-bs-target="#insights-pane" type="button" role="tab"
                                    aria-controls="insights-pane" aria-selected="false">
                                <i class="fas fa-lightbulb me-1"></i> User Insights
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="research-tab" data-bs-toggle="tab"
                                    data-bs-target="#research-pane" type="button" role="tab"
                                    aria-controls="research-pane" aria-selected="false">
                                <i class="fas fa-flask me-1"></i> Research Integration
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="nlcTabContent">
                        <!-- Interaction Analysis Tab -->
                        <div class="tab-pane fade show active" id="interaction-pane" role="tabpanel" 
                             aria-labelledby="interaction-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <form id="interactionForm">
                                        <div class="mb-3">
                                            <label for="inputType" class="form-label">Input Type</label>
                                            <select class="form-select" id="inputType">
                                                <option value="gesture">Gesture</option>
                                                <option value="symbol">Symbol</option>
                                                <option value="text" selected>Text</option>
                                                <option value="sound">Sound</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="inputContent" class="form-label">Input Content</label>
                                            <input type="text" class="form-control" id="inputContent" placeholder="Enter text or symbol name">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="emotionSelect" class="form-label">Emotional State</label>
                                            <select class="form-select" id="emotionSelect">
                                                <option value="positive">Positive</option>
                                                <option value="neutral" selected>Neutral</option>
                                                <option value="negative">Negative</option>
                                                <option value="urgent">Urgent</option>
                                                <option value="inquisitive">Inquisitive</option>
                                                <option value="confused">Confused</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="intentInput" class="form-label">Intent</label>
                                            <input type="text" class="form-control" id="intentInput" placeholder="e.g., request_help, communicate_need" value="communicate">
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn neural-btn">
                                                <i class="fas fa-brain me-2"></i>Analyze Interaction
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <h6>Root Cause Analysis</h6>
                                        <div class="neural-result" id="analysisResult">
                                            <div class="text-center text-light">
                                                <small>Analysis results will appear here</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6>Root Cause Legend</h6>
                                        <div class="d-flex flex-wrap">
                                            <div class="me-3 mb-2">
                                                <span class="root-cause-indicator root-emotional_state"></span> Emotional State
                                            </div>
                                            <div class="me-3 mb-2">
                                                <span class="root-cause-indicator root-sensory_trigger"></span> Sensory Trigger
                                            </div>
                                            <div class="me-3 mb-2">
                                                <span class="root-cause-indicator root-communication_intent"></span> Communication Intent
                                            </div>
                                            <div class="me-3 mb-2">
                                                <span class="root-cause-indicator root-social_context"></span> Social Context
                                            </div>
                                            <div class="me-3 mb-2">
                                                <span class="root-cause-indicator root-cognitive_load"></span> Cognitive Load
                                            </div>
                                            <div class="me-3 mb-2">
                                                <span class="root-cause-indicator root-unknown"></span> Unknown
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Insights Tab -->
                        <div class="tab-pane fade" id="insights-pane" role="tabpanel" 
                             aria-labelledby="insights-tab">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card learning-card">
                                        <div class="card-body">
                                            <h6 class="cyber-title">Total Interactions</h6>
                                            <h2 class="text-center mt-3 mb-3" id="totalInteractions">0</h2>
                                            <p class="small mb-0 text-center"><small>Accumulated learning data points</small></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="card learning-card">
                                        <div class="card-body">
                                            <h6 class="cyber-title">Dominant Root Cause</h6>
                                            <h3 class="text-center mt-3 mb-3" id="dominantCause">Unknown</h3>
                                            <p class="small mb-0 text-center"><small>Primary behavior driver</small></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="card learning-card">
                                        <div class="card-body">
                                            <h6 class="cyber-title">Intent Diversity</h6>
                                            <h2 class="text-center mt-3 mb-3" id="intentDiversity">0</h2>
                                            <p class="small mb-0 text-center"><small>Unique communication intents</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="mb-3">Detected Pattern Insights</h6>
                                <div id="insightsList">
                                    <div class="text-center py-4">
                                        <p class="text-muted">Submit interactions to generate insights</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                                <button id="refreshInsights" class="btn neural-btn">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh Insights
                                </button>
                            </div>
                        </div>
                        
                        <!-- Research Integration Tab -->
                        <div class="tab-pane fade" id="research-pane" role="tabpanel" 
                             aria-labelledby="research-tab">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card learning-card">
                                        <div class="card-body">
                                            <h6 class="cyber-title">Research Articles</h6>
                                            <h2 class="text-center mt-3 mb-3" id="articlesCount">{{ research_status.articles_count }}</h2>
                                            <p class="small mb-0 text-center"><small>Indexed research documents</small></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="card learning-card">
                                        <div class="card-body">
                                            <h6 class="cyber-title">Last Update</h6>
                                            <h3 class="text-center mt-3 mb-3" id="lastUpdate">
                                                {% if research_status.last_update %}
                                                    {{ research_status.last_update.strftime('%Y-%m-%d %H:%M') }}
                                                {% else %}
                                                    Never
                                                {% endif %}
                                            </h3>
                                            <p class="small mb-0 text-center"><small>Research knowledge timestamp</small></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="card learning-card">
                                        <div class="card-body">
                                            <h6 class="cyber-title">Insights Count</h6>
                                            <h2 class="text-center mt-3 mb-3" id="insightsCount">{{ research_status.insights_count }}</h2>
                                            <p class="small mb-0 text-center"><small>Extracted research insights</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="mb-3">Research Areas</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="list-group">
                                            <div class="list-group-item bg-dark text-light insight-item">
                                                <h6><i class="fas fa-comment-alt me-2"></i>Nonverbal Communication</h6>
                                                <p class="mb-0 small">Studies on effective communication techniques for nonverbal individuals</p>
                                            </div>
                                            <div class="list-group-item bg-dark text-light insight-item">
                                                <h6><i class="fas fa-sitemap me-2"></i>AAC Methodologies</h6>
                                                <p class="mb-0 small">Augmentative and alternative communication systems and their efficacy</p>
                                            </div>
                                            <div class="list-group-item bg-dark text-light insight-item">
                                                <h6><i class="fas fa-microchip me-2"></i>AI Assistive Technology</h6>
                                                <p class="mb-0 small">Applications of AI in assistive communication devices</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="list-group">
                                            <div class="list-group-item bg-dark text-light insight-item">
                                                <h6><i class="fas fa-brain me-2"></i>Cognitive Development</h6>
                                                <p class="mb-0 small">Understanding cognitive patterns in neurodivergent individuals</p>
                                            </div>
                                            <div class="list-group-item bg-dark text-light insight-item">
                                                <h6><i class="fas fa-chart-line me-2"></i>Therapeutic Trends</h6>
                                                <p class="mb-0 small">Current and emerging therapy directions for autism spectrum</p>
                                            </div>
                                            <div class="list-group-item bg-dark text-light insight-item">
                                                <h6><i class="fas fa-project-diagram me-2"></i>PECS & Visual Systems</h6>
                                                <p class="mb-0 small">Picture Exchange Communication System implementations</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="researchStatus" class="mt-4 mb-3 text-center"></div>
                            
                            <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                                <button id="updateResearch" class="btn neural-btn">
                                    <i class="fas fa-sync-alt me-2"></i>Update Research Knowledge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths dynamically
    document.querySelectorAll('.progress-bar').forEach(bar => {
        const width = bar.getAttribute('data-width');
        if (width) {
            bar.style.width = `${width}%`;
        }
    });
    // Control buttons
    const startLearningBtn = document.getElementById('start-learning');
    const stopLearningBtn = document.getElementById('stop-learning');
    const startAutoModeBtn = document.getElementById('start-auto-mode');
    const stopAutoModeBtn = document.getElementById('stop-auto-mode');
    
    // Status elements
    const learningStatus = document.getElementById('learning-status');
    const modificationStatus = document.getElementById('modification-status');
    const learningProgress = document.getElementById('learning-progress');
    
    // Learning control
    if (startLearningBtn) {
        startLearningBtn.addEventListener('click', function() {
            fetch('/ai/start-learning', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        startLearningBtn.style.display = 'none';
                        stopLearningBtn.style.display = 'inline-block';
                        learningStatus.textContent = 'Active';
                        learningStatus.classList.replace('bg-secondary', 'bg-success');
                    }
                })
                .catch(error => console.error('Error starting learning:', error));
        });
    }
    
    if (stopLearningBtn) {
        stopLearningBtn.addEventListener('click', function() {
            fetch('/ai/stop-learning', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        stopLearningBtn.style.display = 'none';
                        startLearningBtn.style.display = 'inline-block';
                        learningStatus.textContent = 'Inactive';
                        learningStatus.classList.replace('bg-success', 'bg-secondary');
                    }
                })
                .catch(error => console.error('Error stopping learning:', error));
        });
    }
    
    // Auto-modification control
    if (startAutoModeBtn) {
        startAutoModeBtn.addEventListener('click', function() {
            fetch('/ai/start-auto-mode', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        startAutoModeBtn.style.display = 'none';
                        stopAutoModeBtn.style.display = 'block';
                        modificationStatus.textContent = 'Active';
                        modificationStatus.classList.replace('bg-secondary', 'bg-success');
                    }
                })
                .catch(error => console.error('Error starting auto mode:', error));
        });
    }
    
    if (stopAutoModeBtn) {
        stopAutoModeBtn.addEventListener('click', function() {
            fetch('/ai/stop-auto-mode', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        stopAutoModeBtn.style.display = 'none';
                        startAutoModeBtn.style.display = 'block';
                        modificationStatus.textContent = 'Inactive';
                        modificationStatus.classList.replace('bg-success', 'bg-secondary');
                    }
                })
                .catch(error => console.error('Error stopping auto mode:', error));
        });
    }
    
    // View diff buttons
    document.querySelectorAll('.view-diff-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const diffElem = document.getElementById(`diff-${id}`);
            
            if (diffElem.style.display === 'none') {
                diffElem.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Changes';
            } else {
                diffElem.style.display = 'none';
                this.innerHTML = '<i class="fas fa-code-branch me-1"></i>View Changes';
            }
        });
    });
    
    // Filter modification list
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            const items = document.querySelectorAll('#modifications-list [data-status]');
            
            items.forEach(item => {
                if (filter === 'all' || item.getAttribute('data-status') === filter) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
    
    // Custom improvement form
    const customImprovementForm = document.getElementById('custom-improvement-form');
    if (customImprovementForm) {
        customImprovementForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const filePath = document.getElementById('file-path').value;
            const modificationType = document.getElementById('modification-type').value;
            const issueDescription = document.getElementById('issue-description').value;
            
            if (!filePath || !issueDescription) {
                alert('Please enter a file path and issue description');
                return;
            }
            
            fetch('/ai/queue-modification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    file_path: filePath,
                    issue_description: issueDescription,
                    modification_type: modificationType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Improvement queued successfully');
                    customImprovementForm.reset();
                    
                    // Update pending count
                    const pendingCount = document.getElementById('pending-mods-count');
                    if (pendingCount) {
                        pendingCount.textContent = parseInt(pendingCount.textContent) + 1;
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error queueing improvement:', error);
                alert('Error submitting improvement request');
            });
        });
    }
    
    // Refresh improvements list
    const refreshImprovementsBtn = document.getElementById('refresh-improvements');
    if (refreshImprovementsBtn) {
        refreshImprovementsBtn.addEventListener('click', function() {
            fetch('/ai/improvements')
                .then(response => response.json())
                .then(data => {
                    const improvementsList = document.getElementById('improvements-list');
                    improvementsList.innerHTML = '';
                    
                    if (data.improvements && data.improvements.length > 0) {
                        data.improvements.forEach(improvement => {
                            improvementsList.innerHTML += `
                            <div class="list-group-item bg-dark text-white border-secondary improvement-item">
                                <div class="processor-bar" style="height: 2px; margin-bottom: 10px;"></div>
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 cyber-text"><i class="fas fa-lightbulb me-2"></i>${improvement.description}</h6>
                                    <small class="text-info">${improvement.timestamp}</small>
                                </div>
                                <p class="mb-1 small">${improvement.details}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="progress cyber-progress" style="height: 4px; width: 70%;">
                                        <div class="progress-bar" style="width: ${improvement.confidence}%; background-color: #00cc88;"></div>
                                    </div>
                                    <small class="text-info">Confidence: ${improvement.confidence}%</small>
                                </div>
                            </div>`;
                        });
                    } else {
                        improvementsList.innerHTML = `
                        <div class="list-group-item bg-dark text-white border-secondary text-center">
                            No recent improvements
                        </div>`;
                    }
                })
                .catch(error => console.error('Error refreshing improvements:', error));
        });
    }
    
    // Auto-refresh stats
    function refreshStats() {
        fetch('/ai/stats')
            .then(response => response.json())
            .then(data => {
                // Update learning progress
                if (learningProgress) {
                    learningProgress.style.width = `${data.learning_progress}%`;
                    learningProgress.setAttribute('aria-valuenow', data.learning_progress);
                    learningProgress.innerHTML = `<span class="fw-bold">${data.learning_progress}% Learning Capacity</span>`;
                }
                
                // Update counts
                document.getElementById('interactions-count').textContent = data.interactions_count;
                document.getElementById('pending-mods-count').textContent = data.pending_modifications_count;
                document.getElementById('applied-mods-count').textContent = data.applied_modifications_count;
                
                // Update last optimization
                if (data.last_optimization) {
                    document.getElementById('last-optimization').textContent = data.last_optimization;
                }
                
                // Update learning actions
                const actionsElem = document.getElementById('learning-actions');
                if (actionsElem && data.learning_actions && data.learning_actions.length > 0) {
                    actionsElem.innerHTML = '';
                    data.learning_actions.forEach(action => {
                        actionsElem.innerHTML += `
                        <li class="list-group-item bg-dark text-white border-secondary improvement-item">
                            <div class="d-flex align-items-center">
                                <div class="me-2 position-relative">
                                    <i class="fas fa-cog fa-spin text-info"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle" style="width: 6px; height: 6px; background-color: #00ccff; border-radius: 50%;"></span>
                                </div>
                                <span class="cyber-text">${action}</span>
                            </div>
                        </li>`;
                    });
                }
            })
            .catch(error => console.error('Error refreshing stats:', error));
    }
    
    // Refresh stats every 30 seconds
    setInterval(refreshStats, 30000);
    
    // Neural Learning Core Interaction Handling
    const interactionForm = document.getElementById('interactionForm');
    const refreshInsightsBtn = document.getElementById('refreshInsights');
    
    if (interactionForm) {
        interactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const inputType = document.getElementById('inputType').value;
            const inputContent = document.getElementById('inputContent').value;
            const emotion = document.getElementById('emotionSelect').value;
            const intent = document.getElementById('intentInput').value;
            
            if (!inputContent) {
                alert('Please enter input content');
                return;
            }
            
            // Prepare interaction data
            const interaction = {
                type: inputType,
                input: inputContent,
                emotion: emotion,
                intent: intent,
                confidence: 0.8,  // Default confidence
                context: {
                    time_of_day: new Date().toTimeString().slice(0, 5)  // Current time in HH:MM format
                }
            };
            
            // Send to API
            fetch('/api/learn_root_cause', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ interaction: interaction })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayAnalysisResult(data, interaction);
                    // Refresh insights after new data
                    setTimeout(fetchUserInsights, 1000);
                } else {
                    document.getElementById('analysisResult').innerHTML = `
                        <div class="alert alert-danger">
                            ${data.message || 'Error processing interaction'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('analysisResult').innerHTML = `
                    <div class="alert alert-danger">
                        Error connecting to server: ${error.message}
                    </div>
                `;
            });
        });
    }
    
    if (refreshInsightsBtn) {
        refreshInsightsBtn.addEventListener('click', function() {
            fetchUserInsights();
        });
    }
    
    function displayAnalysisResult(data, interaction) {
        const rootCause = data.root_cause;
        const confidence = (data.confidence * 100).toFixed(1);
        
        let confidenceClass = 'text-danger';
        if (data.confidence > 0.7) confidenceClass = 'text-success';
        else if (data.confidence > 0.4) confidenceClass = 'text-warning';
        
        const timestamp = new Date().toLocaleTimeString();
        
        document.getElementById('analysisResult').innerHTML = `
            <div class="mb-3">
                <strong>Input:</strong> ${interaction.type} - ${interaction.input}<br>
                <strong>Intent:</strong> ${interaction.intent}<br>
                <strong>Emotion:</strong> ${interaction.emotion}<br>
                <strong>Time:</strong> ${timestamp}
            </div>
            <div class="mt-3 pt-3 border-top">
                <h6><span class="root-cause-indicator root-${rootCause}"></span>
                Root Cause: ${formatRootCause(rootCause)}</h6>
                <p>Confidence: <span class="${confidenceClass}">${confidence}%</span></p>
            </div>
        `;
    }
    
    function fetchUserInsights() {
        // Get insights for current user
        fetch('/api/user_insights/current')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayInsights(data.insights, data.summary);
            } else {
                document.getElementById('insightsList').innerHTML = `
                    <div class="alert alert-info">
                        No insights available yet. Continue interacting with the system.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('insightsList').innerHTML = `
                <div class="alert alert-danger">
                    Error fetching insights: ${error.message}
                </div>
            `;
        });
    }
    
    function displayInsights(insights, summary) {
        // Update summary stats
        if (document.getElementById('totalInteractions')) {
            document.getElementById('totalInteractions').textContent = summary.total_interactions || 0;
            document.getElementById('dominantCause').textContent = formatRootCause(summary.dominant_root_cause || 'unknown');
            document.getElementById('intentDiversity').textContent = summary.intent_diversity || 0;
        }
        
        // Update insights list
        const insightsList = document.getElementById('insightsList');
        if (!insightsList) return;
        
        if (!insights || insights.length === 0) {
            insightsList.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">No significant patterns detected yet</p>
                </div>
            `;
            return;
        }
        
        let insightsHTML = '';
        insights.forEach(insight => {
            const frequency = (insight.frequency * 100).toFixed(0);
            insightsHTML += `
                <div class="insight-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="mb-1">
                            <span class="root-cause-indicator root-${insight.root_cause}"></span>
                            ${formatRootCause(insight.root_cause)}
                        </h6>
                        <span class="confidence-badge">${frequency}%</span>
                    </div>
                    <p class="mb-0 small">${insight.description}</p>
                </div>
            `;
        });
        
        insightsList.innerHTML = insightsHTML;
    }
    
    function formatRootCause(rootCause) {
        // Convert snake_case to Title Case with spaces
        if (!rootCause) return 'Unknown';
        
        return rootCause
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    
    // Initialize insights on page load
    fetchUserInsights();
    
    // Research Update Functionality
    const updateResearchBtn = document.getElementById('updateResearch');
    const researchStatus = document.getElementById('researchStatus');
    
    if (updateResearchBtn && researchStatus) {
        updateResearchBtn.addEventListener('click', function() {
            updateResearchBtn.disabled = true;
            researchStatus.innerHTML = '<div class="text-center py-2"><div class="spinner-border text-info" role="status"></div><p class="mt-2">Fetching latest research and updating knowledge base...</p></div>';
            
            fetch('/api/update_research', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update the displayed stats
                        document.getElementById('articlesCount').textContent = data.articles_fetched || 0;
                        document.getElementById('insightsCount').textContent = data.insights_extracted || 0;
                        document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                        
                        // Show success message
                        researchStatus.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>Research knowledge updated successfully!
                                <p class="mb-0 mt-2 small">
                                    ${data.articles_fetched} articles fetched, ${data.insights_extracted} insights extracted
                                </p>
                            </div>`;
                    } else {
                        // Show error message
                        researchStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>Error updating research knowledge
                                <p class="mb-0 mt-2 small">${data.message || 'Unknown error'}</p>
                            </div>`;
                    }
                    updateResearchBtn.disabled = false;
                })
                .catch(error => {
                    console.error('Error updating research:', error);
                    researchStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Error connecting to server
                            <p class="mb-0 mt-2 small">Please try again later</p>
                        </div>`;
                    updateResearchBtn.disabled = false;
                });
        });
    }
});
</script>
{% endblock %}